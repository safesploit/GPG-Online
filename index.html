<!DOCTYPE html>
<html>
<head>
  <title>SWS Client-side GPG</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <script src="assets/js/script.js"></script>
  <script src="openpgp.min.js"></script>
</head>
<body>

<h1>Client-side GPG</h1>

<div class="message">
  <h2>Message to encrypt</h2>
  <textarea rows="5"></textarea>
</div>

<div id="public-keys">
  <div class="public-key">
    <h2>Public key</h2>
    <p class="hint">Only the person who has a private key will be able to decrypt the message.</p>
    <textarea rows="5">
-----BEGIN PGP PUBLIC KEY BLOCK-----

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
=/NJA
-----END PGP PUBLIC KEY BLOCK-----
    </textarea>
  </div>
</div>

<div id="private-key">
  <h2>Private Key</h2>
  <textarea rows="5"></textarea>
  <h2>Passphrase</h2>
  <textarea rows="2"></textarea>
</div>

<div class="output">
  <pre id="output"></pre>
</div>
<button id="encrypt">Encrypt</button>
<button id="add-public-key">Add Public Key</button>
<button id="add-private-key">Add Private Key</button>

<script>
  const query = query => document.querySelector(query);
  const queryAll = query => Array.prototype.slice.apply(document.querySelectorAll(query));
  const publicKeyTemplate = query('#public-keys').innerHTML;

  query('#add-public-key').addEventListener('click', () => {
    const element = document.createElement('div');
    element.innerHTML = publicKeyTemplate;
    query('#public-keys').appendChild(element);
  });

  query('#add-private-key').addEventListener('click', () => {
    query('#private-key').className = 'visible';
  });

  function getKey(textarea, type) {
    const { value } = textarea;
    if (!value) {
      throw new Error(`${type} key missing`);
    }
    return openpgp.key.readArmored(value).keys[0];
  }

  function getPrivateKey() {
    if (query('#private-key').className !== 'visible') {
      return Promise.resolve();
    }

    const [key, passphrase] = queryAll('#private-key textarea');
    return openpgp.decryptKey({
      privateKey: getKey(key, 'private'),
      passphrase: passphrase.value,
    })
    .then(({key}) => key)
    ;
  }

  function copyOutputClipboard() {
    var copyText = document.getElementById("output");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    
    var tooltip = document.getElementById("output");
    tooltip.innerHTML = "Copied: " + copyText.value;
  }

  query('#encrypt').addEventListener('click', () => {
    getPrivateKey().then(privateKey => {
      const options = {
        data: query('.message textarea').value,
        publicKeys: queryAll('.public-key textarea').map(el => getKey(el, 'public')),
        privateKey: privateKey,
        armor: true,
      };

      return openpgp.encrypt(options).then(results => {
        $var =  "<hr>" + 
                "<textarea rows=10>" + 
                  results.data + 
                "</textarea>" + 
                "<br>" + 
                "<button onclick='copyOutputClipboard()' id='copy'>Copy to Clipboard</button>" + 
                "<hr>";
        query('#output').innerHTML = $var;
      });
    })
    .catch(err => alert(err.message))
    ;
  });
</script>

<p>
  This page uses industry vetted open source <a href="https://github.com/openpgpjs/openpgpjs">OpenPGP.js</a> and does not submit anything to the server. Everything happens in your browser and is completely lost when you close this page.
</p>

</body>
</html>
